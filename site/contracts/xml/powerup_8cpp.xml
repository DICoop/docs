<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.3" xml:lang="ru">
  <compounddef id="powerup_8cpp" kind="file" language="C++">
    <compoundname>powerup.cpp</compoundname>
    <includes refid="eosio_8system_8hpp" local="no">eosio.system/eosio.system.hpp</includes>
    <includes refid="eosio_8token_8hpp" local="no">eosio.token/eosio.token.hpp</includes>
    <includes local="no">eosio/action.hpp</includes>
    <includes local="no">algorithm</includes>
    <includes local="no">cmath</includes>
    <incdepgraph>
      <node id="23">
        <label>../../../../../common/consts.hpp</label>
        <link refid="consts_8hpp"/>
      </node>
      <node id="2">
        <label>eosio.system/eosio.system.hpp</label>
        <link refid="eosio_8system_8hpp"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
      </node>
      <node id="10">
        <label>eosio.system/exchange_state.hpp</label>
        <link refid="exchange__state_8hpp"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="12">
        <label>eosio.system/native.hpp</label>
        <link refid="native_8hpp"/>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>system/contracts/eosio.system/src/powerup.cpp</label>
        <link refid="powerup_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
      </node>
      <node id="24">
        <label>eosio.token/eosio.token.hpp</label>
        <link refid="eosio_8token_8hpp"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="26">
        <label>algorithm</label>
      </node>
      <node id="27">
        <label>cmath</label>
      </node>
      <node id="19">
        <label>deque</label>
      </node>
      <node id="13">
        <label>eosio/action.hpp</label>
      </node>
      <node id="3">
        <label>eosio/asset.hpp</label>
      </node>
      <node id="4">
        <label>eosio/binary_extension.hpp</label>
      </node>
      <node id="14">
        <label>eosio/contract.hpp</label>
      </node>
      <node id="15">
        <label>eosio/crypto.hpp</label>
      </node>
      <node id="25">
        <label>eosio/eosio.hpp</label>
      </node>
      <node id="16">
        <label>eosio/fixed_bytes.hpp</label>
      </node>
      <node id="17">
        <label>eosio/ignore.hpp</label>
      </node>
      <node id="11">
        <label>eosio/multi_index.hpp</label>
      </node>
      <node id="18">
        <label>eosio/print.hpp</label>
      </node>
      <node id="5">
        <label>eosio/privileged.hpp</label>
      </node>
      <node id="6">
        <label>eosio/producer_schedule.hpp</label>
      </node>
      <node id="7">
        <label>eosio/singleton.hpp</label>
      </node>
      <node id="8">
        <label>eosio/system.hpp</label>
      </node>
      <node id="9">
        <label>eosio/time.hpp</label>
      </node>
      <node id="20">
        <label>optional</label>
      </node>
      <node id="21">
        <label>string</label>
      </node>
      <node id="22">
        <label>type_traits</label>
      </node>
    </incdepgraph>
    <innernamespace refid="namespaceeosiosystem">eosiosystem</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="preprocessor">#include<sp/>&lt;<ref refid="eosio_8system_8hpp" kindref="compound">eosio.system/eosio.system.hpp</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="eosio_8token_8hpp" kindref="compound">eosio.token/eosio.token.hpp</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;eosio/action.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;algorithm&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cmath&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespaceeosiosystem" kindref="compound">eosiosystem</ref><sp/>{</highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1af207e91e13bb386b49b1e1c2ed0fb616" kindref="member">system_contract::adjust_resources</ref>(name<sp/>payer,<sp/>name<sp/><ref refid="structaccount" kindref="compound">account</ref>,<sp/>symbol<sp/>core_symbol,<sp/>int64_t<sp/>net_delta,</highlight></codeline>
<codeline lineno="10"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>cpu_delta,<sp/>int64_t<sp/>ram_delta,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>must_not_be_managed)<sp/>{</highlight></codeline>
<codeline lineno="11"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!net_delta<sp/>&amp;&amp;<sp/>!cpu_delta<sp/>&amp;&amp;<sp/>!ram_delta)</highlight></codeline>
<codeline lineno="12"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="13"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="14"><highlight class="normal"><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a392bb6f33cd89eca7b90ee378a7ac8e3" kindref="member">user_resources_table</ref><sp/>totals_tbl(get_self(),<sp/><ref refid="structaccount" kindref="compound">account</ref>.value);</highlight></codeline>
<codeline lineno="15"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot_itr<sp/>=<sp/>totals_tbl.find(<ref refid="structaccount" kindref="compound">account</ref>.value);</highlight></codeline>
<codeline lineno="16"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tot_itr<sp/>==<sp/>totals_tbl.end())<sp/>{</highlight></codeline>
<codeline lineno="17"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>tot_itr<sp/>=<sp/>totals_tbl.emplace(payer,<sp/>[&amp;](</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tot)<sp/>{</highlight></codeline>
<codeline lineno="18"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.owner<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/><ref refid="structaccount" kindref="compound">account</ref>;</highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.net_weight<sp/>=<sp/>asset{<sp/>net_delta,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref><sp/>};</highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.cpu_weight<sp/>=<sp/>asset{<sp/>cpu_delta,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref><sp/>};</highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.ram_bytes<sp/><sp/>=<sp/>ram_delta;</highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="23"><highlight class="normal"><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>totals_tbl.modify(tot_itr,<sp/>payer,<sp/>[&amp;](</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tot)<sp/>{</highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.net_weight.amount<sp/>+=<sp/>net_delta;</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.cpu_weight.amount<sp/>+=<sp/>cpu_delta;</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.ram_bytes<sp/>+=<sp/>ram_delta;</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/>check(0<sp/>&lt;=<sp/>tot_itr-&gt;net_weight.amount,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>total<sp/>net<sp/>bandwidth&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/>check(0<sp/>&lt;=<sp/>tot_itr-&gt;cpu_weight.amount,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>total<sp/>cpu<sp/>bandwidth&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/><sp/>check(0<sp/>&lt;=<sp/>tot_itr-&gt;ram_bytes,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>total<sp/>ram&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ram_managed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>net_managed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>cpu_managed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>voter_itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.find(<ref refid="structaccount" kindref="compound">account</ref>.value);</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(voter_itr<sp/>!=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ram_managed<sp/>=<sp/><ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5ae149b497807ee78e9e5180d213e5a402" kindref="member">voter_info::flags1_fields::ram_managed</ref>);</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>net_managed<sp/>=<sp/><ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5a944559ad694d4c0fc4bf286864caf2a2" kindref="member">voter_info::flags1_fields::net_managed</ref>);</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cpu_managed<sp/>=<sp/><ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5ace319c6a1aa0ced6ea5a02270d863f4c" kindref="member">voter_info::flags1_fields::cpu_managed</ref>);</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(must_not_be_managed)</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::check(!net_managed<sp/>&amp;&amp;<sp/>!cpu_managed,<sp/></highlight><highlight class="stringliteral">&quot;something<sp/>is<sp/>managed<sp/>which<sp/>shouldn&apos;t<sp/>be&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(net_managed<sp/>&amp;&amp;<sp/>cpu_managed<sp/>&amp;&amp;<sp/>ram_managed))<sp/>{</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>old_ram_limit,<sp/>net,<sp/>cpu,<sp/>ram_usage,<sp/>ram_limit,<sp/>ram_debt,<sp/>ram_to_back;</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_resource_limits(<ref refid="structaccount" kindref="compound">account</ref>,<sp/>old_ram_limit,<sp/>net,<sp/>cpu);</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_account_ram_usage(<ref refid="structaccount" kindref="compound">account</ref>,<sp/>ram_usage);</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ram_debt<sp/>=<sp/>0;<sp/></highlight><highlight class="comment">//<sp/>Initialize<sp/>ram_debt<sp/>to<sp/>0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ram_to_back<sp/>=<sp/>0;<sp/></highlight><highlight class="comment">//<sp/>Initialize<sp/>ram_to_back<sp/>to<sp/>0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>new_ram_limit<sp/>=<sp/>old_ram_limit;</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ram_delta<sp/>!=<sp/>0)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>применяем<sp/>только<sp/>если<sp/>были<sp/>изменения<sp/>по<sp/>квоте<sp/>RAM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_ram_limit<sp/>=<sp/>old_ram_limit<sp/>+<sp/>ram_delta;</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_ram_limit<sp/>&lt;<sp/>ram_usage)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>если<sp/>новый<sp/>лимит<sp/>меньше,<sp/>чем<sp/>используется<sp/>байт,<sp/>то<sp/>формируем<sp/>долг</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ram_debt<sp/>=<sp/>-<sp/>(ram_usage<sp/>-<sp/>new_ram_limit);<sp/></highlight><highlight class="comment">//<sp/>новый<sp/>долг<sp/>-<sp/>это<sp/>отрицательная<sp/>величина</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_ram_limit<sp/>=<sp/>ram_usage;<sp/></highlight><highlight class="comment">//<sp/>новый<sp/>лимит<sp/>-<sp/>это<sp/>вся<sp/>используемая<sp/>память,<sp/>т.е.<sp/>квота<sp/>будет<sp/>равна<sp/>0<sp/>байт</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a04a864fd31b03ca4e7ce3a9fd65476c7" kindref="member">update_ram_debt_table</ref>(payer,<sp/><ref refid="structaccount" kindref="compound">account</ref>,<sp/>ram_debt);</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>the<sp/>new<sp/>resource<sp/>limits</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_resource_limits(<ref refid="structaccount" kindref="compound">account</ref>,<sp/>new_ram_limit,<sp/>net<sp/>+<sp/>net_delta,<sp/>cpu<sp/>+<sp/>cpu_delta);</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="71"><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tot_itr-&gt;is_empty())<sp/>{</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>totals_tbl.erase(tot_itr);</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="75"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>system_contract::adjust_resources</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a0fd50f24c66c025a7efd13b0cc24e23e" kindref="member">system_contract::process_powerup_queue</ref>(time_point_sec<sp/>now,<sp/>symbol<sp/>core_symbol,<sp/>powerup_state&amp;<sp/>state,</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1ab020b27ad4ebc87d910cb31fbcf9e7ac" kindref="member">powerup_order_table</ref>&amp;<sp/>orders,<sp/>uint32_t<sp/>max_items,<sp/>int64_t&amp;<sp/>net_delta_available,</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t&amp;<sp/>cpu_delta_available,<sp/>int64_t&amp;<sp/>ram_delta_available)<sp/>{</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>idx<sp/>=<sp/>orders.get_index&lt;</highlight><highlight class="stringliteral">&quot;byexpires&quot;</highlight><highlight class="normal">_n&gt;();</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(max_items--)<sp/>{</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>idx.begin();</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>idx.end()<sp/>||<sp/>it-&gt;expires<sp/>&gt;<sp/>now)</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>net_delta_available<sp/>+=<sp/>it-&gt;net_weight;</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>cpu_delta_available<sp/>+=<sp/>it-&gt;cpu_weight;</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>ram_delta_available<sp/>+=<sp/>it-&gt;ram_bytes;</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1af207e91e13bb386b49b1e1c2ed0fb616" kindref="member">adjust_resources</ref>(get_self(),<sp/>it-&gt;owner,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>-it-&gt;net_weight,<sp/>-it-&gt;cpu_weight,<sp/>-it<sp/>-&gt;<sp/>ram_bytes);</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>idx.erase(it);</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/>state.net.utilization<sp/>-=<sp/>net_delta_available;</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/>state.cpu.utilization<sp/>-=<sp/>cpu_delta_available;</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/>state.ram.utilization<sp/>-=<sp/>ram_delta_available;</highlight></codeline>
<codeline lineno="96"><highlight class="normal">}</highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1ae71212071f747832a2a56eb4868d9c81" kindref="member">system_contract::cfgpowerup</ref>(powerup_config&amp;<sp/>args)<sp/>{</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/>require_auth(get_self());</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/>time_point_sec<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>now<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref><sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a50976d2a74593cdd840662159dc21ab1" kindref="member">get_core_symbol</ref>();</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state<sp/>=<sp/>state_sing.get_or_default();</highlight></codeline>
<codeline lineno="104"><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/>eosio::check(eosio::is_account(<ref refid="group__public__consts_1ga98383cb202d2d3d56f7796a53a7f3d03" kindref="member">_power_account</ref>),<sp/></highlight><highlight class="stringliteral">&quot;eosio.power<sp/>account<sp/>must<sp/>first<sp/>be<sp/>created&quot;</highlight><highlight class="normal">);<sp/></highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/>int64_t<sp/>net_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/>int64_t<sp/>cpu_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>is_default_asset<sp/>=<sp/>[](<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>eosio::asset&amp;<sp/>a<sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>a.amount<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>a.symbol<sp/>==<sp/>symbol{};</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="113"><highlight class="normal"></highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!args.powerup_days)<sp/>{</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>*args.powerup_days<sp/>=<sp/>state.powerup_days;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!args.min_powerup_fee)<sp/>{</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>eosio::check(!is_default_asset(state.min_powerup_fee),<sp/></highlight><highlight class="stringliteral">&quot;min_powerup_fee<sp/>does<sp/>not<sp/>have<sp/>a<sp/>default<sp/>value&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>*args.min_powerup_fee<sp/>=<sp/>state.min_powerup_fee;</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="122"><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/>eosio::check(*args.powerup_days<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;powerup_days<sp/>must<sp/>be<sp/>&gt;<sp/>0&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/>eosio::check(args.min_powerup_fee-&gt;symbol<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/></highlight><highlight class="stringliteral">&quot;min_powerup_fee<sp/>doesn&apos;t<sp/>match<sp/>core<sp/>symbol&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/>eosio::check(args.min_powerup_fee-&gt;amount<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;min_powerup_fee<sp/>must<sp/>be<sp/>positive&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/>state.powerup_days<sp/><sp/><sp/><sp/>=<sp/>*args.powerup_days;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/>state.min_powerup_fee<sp/>=<sp/>*args.min_powerup_fee;</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_supply<sp/>=<sp/><ref refid="classeosio_1_1token_1af0ca80206f8f0131147b0bec367c62d3" kindref="member">eosio::token::get_supply</ref>(<ref refid="classeosiosystem_1_1system__contract_1a21c029a978b1648e8cea9d7c60a5faf3" kindref="member">token_account</ref>,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>.code()<sp/>);</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/>state.net.weight<sp/>=<sp/>current_supply.amount;</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/>state.cpu.weight<sp/>=<sp/>current_supply.amount;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/>state.ram.weight<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a2a2f2607dd31f0623a7d5185bf967c4d" kindref="member">max_ram_size</ref>;</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/>state.ram.utilization<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a2a2f2607dd31f0623a7d5185bf967c4d" kindref="member">max_ram_size</ref><sp/>-<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab13e31d124330a1ba278dfb46fdee173" kindref="member">free_ram</ref>();</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>free_ram<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab13e31d124330a1ba278dfb46fdee173" kindref="member">free_ram</ref>();</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab11f6efb709f15f9d31c3e8a20897149" kindref="member">total_ram_bytes_reserved</ref><sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a2a2f2607dd31f0623a7d5185bf967c4d" kindref="member">max_ram_size</ref>;</highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1af207e91e13bb386b49b1e1c2ed0fb616" kindref="member">adjust_resources</ref>(get_self(),<sp/><ref refid="group__public__consts_1ga98383cb202d2d3d56f7796a53a7f3d03" kindref="member">_power_account</ref>,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>state.net.weight,<sp/>state.cpu.weight,<sp/>free_ram,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/>state_sing.set(state,<sp/>get_self());</highlight></codeline>
<codeline lineno="141"><highlight class="normal">}</highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1aa573d628b237c167aa99fc71cb150736" kindref="member">system_contract::powerupexec</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>user,<sp/>uint16_t<sp/>max)<sp/>{</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/>require_auth(user);</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1ab020b27ad4ebc87d910cb31fbcf9e7ac" kindref="member">powerup_order_table</ref><sp/><sp/><sp/><sp/><sp/>orders{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/>eosio::check(state_sing.exists(),<sp/></highlight><highlight class="stringliteral">&quot;powerup<sp/>hasn&apos;t<sp/>been<sp/>initialized&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state<sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>state_sing.get();</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/>time_point_sec<sp/>now<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref><sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a50976d2a74593cdd840662159dc21ab1" kindref="member">get_core_symbol</ref>();</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/>int64_t<sp/>net_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/>int64_t<sp/>cpu_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/>int64_t<sp/>ram_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a0fd50f24c66c025a7efd13b0cc24e23e" kindref="member">process_powerup_queue</ref>(now,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>state,<sp/>orders,<sp/>max,<sp/>net_delta_available,<sp/>cpu_delta_available,<sp/>ram_delta_available);</highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1af207e91e13bb386b49b1e1c2ed0fb616" kindref="member">adjust_resources</ref>(get_self(),<sp/><ref refid="group__public__consts_1ga98383cb202d2d3d56f7796a53a7f3d03" kindref="member">_power_account</ref>,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>net_delta_available,<sp/>cpu_delta_available,<sp/>ram_delta_available,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/>state_sing.set(state,<sp/>get_self());</highlight></codeline>
<codeline lineno="160"><highlight class="normal">}</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1ab3d6d9e77d6b9ac63b79e6d8104d8312" kindref="member">system_contract::powerup</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>payer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>receiver,<sp/>uint32_t<sp/>days,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>payment,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>transfer)<sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/>require_auth(payer);</highlight></codeline>
<codeline lineno="164"><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(transfer<sp/>==<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/>check(has_auth(<ref refid="group__public__consts_1gae4d59ec28af0642e3072dd36dd0a537b" kindref="member">_registrator</ref>)<sp/>||<sp/>has_auth(get_self()),<sp/></highlight><highlight class="stringliteral">&quot;Недостаточно<sp/>прав<sp/>доступа<sp/>для<sp/>перевода<sp/>ресурсов&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/>};</highlight></codeline>
<codeline lineno="168"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/>eosio::check(payment.amount<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Payment<sp/>must<sp/>be<sp/>positive&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><ref refid="namespaceeosiosystem_1ab020b27ad4ebc87d910cb31fbcf9e7ac" kindref="member">powerup_order_table</ref><sp/>orders{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/>eosio::check(state_sing.exists(),<sp/></highlight><highlight class="stringliteral">&quot;powerup<sp/>hasn&apos;t<sp/>been<sp/>initialized&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>state<sp/>=<sp/>state_sing.get();</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/>time_point_sec<sp/>now<sp/>=<sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref><sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a50976d2a74593cdd840662159dc21ab1" kindref="member">get_core_symbol</ref>();</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/>eosio::check(payment.symbol<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Payment<sp/>doesn&apos;t<sp/>match<sp/>core<sp/>symbol&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/>eosio::check(days<sp/>==<sp/>state.powerup_days,<sp/></highlight><highlight class="stringliteral">&quot;Days<sp/>doesn&apos;t<sp/>match<sp/>configuration&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="178"><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Divide<sp/>payment</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/>eosio::asset<sp/>net_payment<sp/>=<sp/>payment<sp/>/<sp/>4;<sp/></highlight><highlight class="comment">//<sp/>25%</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/>eosio::asset<sp/>cpu_payment<sp/>=<sp/>payment<sp/>/<sp/>4;<sp/></highlight><highlight class="comment">//<sp/>25%</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/>eosio::asset<sp/>ram_payment<sp/>=<sp/>payment<sp/>/<sp/>2;<sp/></highlight><highlight class="comment">//<sp/>50%</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/>int64_t<sp/>net_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/>int64_t<sp/>cpu_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/>int64_t<sp/>ram_delta_available<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a0fd50f24c66c025a7efd13b0cc24e23e" kindref="member">process_powerup_queue</ref>(now,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>state,<sp/>orders,<sp/>2,<sp/>net_delta_available,<sp/>cpu_delta_available,<sp/>ram_delta_available);</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Process<sp/>NET<sp/>and<sp/>CPU<sp/>fractions<sp/>separately<sp/>based<sp/>on<sp/>specified<sp/>payment<sp/>portions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/>int64_t<sp/>net_frac<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/>int64_t<sp/>cpu_frac<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/>int64_t<sp/>ram_frac<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="194"><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.net.weight<sp/>&gt;<sp/>0)</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/>net_frac<sp/>=<sp/>net_payment.amount;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.cpu.weight<sp/>&gt;<sp/>0)</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/>cpu_frac<sp/>=<sp/>cpu_payment.amount;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.ram.weight<sp/>&gt;<sp/>0)</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/>ram_frac<sp/>=<sp/>ram_payment.amount;</highlight></codeline>
<codeline lineno="201"><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>RAM<sp/>from<sp/>linear<sp/>market</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/>net_delta_available<sp/>-=<sp/>net_frac;</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/>cpu_delta_available<sp/>-=<sp/>cpu_frac;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Process<sp/>the<sp/>NET<sp/>and<sp/>CPU<sp/>powerup</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="namespacesystem__contracts_1_1testing_1_1test__contracts_1_1blockinfo__tester_1a705f35a783c6830287ee92b4f8146d49" kindref="member">process</ref><sp/>=<sp/>[&amp;](int64_t<sp/>amount,<sp/>powerup_state_resource&amp;<sp/>resource)<sp/>{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(amount<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>eosio::check(resource.weight,<sp/></highlight><highlight class="stringliteral">&quot;market<sp/>doesn&apos;t<sp/>have<sp/>resources<sp/>available&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>eosio::check(resource.utilization<sp/>+<sp/>amount<sp/>&lt;=<sp/>resource.weight,<sp/></highlight><highlight class="stringliteral">&quot;market<sp/>doesn&apos;t<sp/>have<sp/>enough<sp/>resources<sp/>available&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>resource.utilization<sp/>+=<sp/>amount;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/>};</highlight></codeline>
<codeline lineno="214"><highlight class="normal"></highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><ref refid="namespacesystem__contracts_1_1testing_1_1test__contracts_1_1blockinfo__tester_1a705f35a783c6830287ee92b4f8146d49" kindref="member">process</ref>(net_frac,<sp/>state.net);</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><ref refid="namespacesystem__contracts_1_1testing_1_1test__contracts_1_1blockinfo__tester_1a705f35a783c6830287ee92b4f8146d49" kindref="member">process</ref>(cpu_frac,<sp/>state.cpu);</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><ref refid="namespacesystem__contracts_1_1testing_1_1test__contracts_1_1blockinfo__tester_1a705f35a783c6830287ee92b4f8146d49" kindref="member">process</ref>(ram_frac,<sp/>state.ram);</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/>eosio::check(payment<sp/>&gt;=<sp/>state.min_powerup_fee,<sp/></highlight><highlight class="stringliteral">&quot;Payment<sp/>is<sp/>below<sp/>minimum&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/>state_sing.set(state,<sp/>get_self());</highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/>int64_t<sp/>ram_after_pay_debt<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a04a864fd31b03ca4e7ce3a9fd65476c7" kindref="member">update_ram_debt_table</ref>(payer,<sp/>receiver,<sp/>ram_frac);<sp/></highlight></codeline>
<codeline lineno="224"><highlight class="normal"></highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/>ram_delta_available<sp/>-=<sp/>ram_after_pay_debt;</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/>eosio::check(ram_after_pay_debt<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Недостаточное<sp/>пополнение<sp/>ресурсов<sp/>для<sp/>погашения<sp/>используемой<sp/>RAM.<sp/>Попробуйте<sp/>увеличить<sp/>сумму<sp/>пополнения.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(transfer<sp/>==<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">){</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/>orders.emplace(payer,<sp/>[&amp;](</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>order)<sp/>{</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>order.id<sp/>=<sp/>orders.available_primary_key();</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>order.owner<sp/>=<sp/>receiver;</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>order.net_weight<sp/>=<sp/>net_frac;</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>order.cpu_weight<sp/>=<sp/>cpu_frac;</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>order.ram_bytes<sp/>=<sp/>ram_after_pay_debt;</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>order.expires<sp/>=<sp/>now<sp/>+<sp/>eosio::days(days);</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/>};</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1af207e91e13bb386b49b1e1c2ed0fb616" kindref="member">adjust_resources</ref>(get_self(),<sp/><ref refid="group__public__consts_1ga98383cb202d2d3d56f7796a53a7f3d03" kindref="member">_power_account</ref>,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>net_delta_available,<sp/>cpu_delta_available,<sp/>ram_delta_available,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1af207e91e13bb386b49b1e1c2ed0fb616" kindref="member">adjust_resources</ref>(get_self(),<sp/>receiver,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>,<sp/>net_frac,<sp/>cpu_frac,<sp/>ram_after_pay_debt,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a682be09e4bcb430df8e2ce98f1912563" kindref="member">fill_tact</ref>(payer,<sp/>payment);</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="244"><highlight class="normal">}</highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal">int64_t<sp/><ref refid="classeosiosystem_1_1system__contract_1a04a864fd31b03ca4e7ce3a9fd65476c7" kindref="member">system_contract::update_ram_debt_table</ref>(name<sp/>payer,<sp/>name<sp/><ref refid="structaccount" kindref="compound">account</ref>,<sp/>int64_t<sp/>ram_bytes)<sp/>{</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a52ceb5dd9d2a80698c83a32fb4b3e62f" kindref="member">ram_debts_table</ref><sp/>debts(get_self(),<sp/>get_self().value);</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>remaining_ram<sp/>=<sp/>ram_bytes;</highlight></codeline>
<codeline lineno="249"><highlight class="normal"></highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>debt_itr<sp/>=<sp/>debts.find(<ref refid="structaccount" kindref="compound">account</ref>.value);</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(debt_itr<sp/>!=<sp/>debts.end())<sp/>{</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>debt<sp/>=<sp/>debt_itr-&gt;ram_debt;</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::check(debt<sp/>&lt;=<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Запись<sp/>о<sp/>долге<sp/>имеет<sp/>положительное<sp/>значение,<sp/>что<sp/>недопустимо.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="254"><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ram_bytes<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remaining_ram<sp/>+=<sp/>debt;<sp/></highlight><highlight class="comment">//<sp/>Уменьшение<sp/>доступного<sp/>количества<sp/>ram_bytes<sp/>на<sp/>величину<sp/>долга</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(remaining_ram<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>debts.erase(debt_itr);<sp/></highlight><highlight class="comment">//<sp/>Долг<sp/>полностью<sp/>погашен<sp/>или<sp/>долга<sp/>не<sp/>было</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>debts.modify(debt_itr,<sp/>payer,<sp/>[&amp;](</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>d)<sp/>{</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>d.ram_debt<sp/>+=<sp/>ram_bytes;<sp/></highlight><highlight class="comment">//<sp/>Часть<sp/>долга<sp/>погашена</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remaining_ram<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ram_bytes<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Создание<sp/>новой<sp/>записи<sp/>о<sp/>долге<sp/>для<sp/>отрицательного<sp/>количества<sp/>ram_bytes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>debts.emplace(payer,<sp/>[&amp;](</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>record)<sp/>{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>record.account<sp/>=<sp/><ref refid="structaccount" kindref="compound">account</ref>;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>record.ram_debt<sp/>=<sp/>ram_bytes;</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};<sp/></highlight><highlight class="comment">//<sp/>для<sp/>положительного<sp/>ничего<sp/>не<sp/>делаем</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="275"><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>remaining_ram;</highlight></codeline>
<codeline lineno="277"><highlight class="normal">}</highlight></codeline>
<codeline lineno="278"><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"></highlight></codeline>
<codeline lineno="280"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1af6ed697e2d198ca5bce29cbacb682490" kindref="member">system_contract::initemission</ref>(eosio::asset<sp/>init_supply,<sp/>uint64_t<sp/>tact_duration,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>emission_factor)<sp/>{</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/>require_auth(get_self());</highlight></codeline>
<codeline lineno="282"><highlight class="normal"></highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><ref refid="namespaceeosiosystem_1acc6ad551520c18fdac72d2ef9bfb26a9" kindref="member">emission_state_singleton</ref><sp/>emission_state_sing{<sp/>get_self(),<sp/>get_self().value};</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/>eosio::check(!emission_state_sing.exists(),<sp/></highlight><highlight class="stringliteral">&quot;Эмиссия<sp/>уже<sp/>инициализирована.<sp/>Повторная<sp/>инициализация<sp/>невозможна&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/>eosio::check(init_supply.amount<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Стартовый<sp/>объем<sp/>токенов<sp/>не<sp/>может<sp/>быть<sp/>отрицательной&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/>eosio::check(init_supply.symbol<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>(),<sp/></highlight><highlight class="stringliteral">&quot;Неверный<sp/>символ&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/>eosio::check(tact_duration<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Продолжительность<sp/>такта<sp/>должна<sp/>быть<sp/>положительной&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/>eosio::check(tact_duration<sp/>&lt;=<sp/>365<sp/>*<sp/>86400,<sp/></highlight><highlight class="stringliteral">&quot;Продолжительность<sp/>такта<sp/>не<sp/>может<sp/>превышать<sp/>1<sp/>год&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/>eosio::check(emission_factor<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>emission_factor<sp/>&lt;=<sp/>1,<sp/></highlight><highlight class="stringliteral">&quot;Фактор<sp/>эмиссии<sp/>должен<sp/>быть<sp/>больше<sp/>нуля<sp/>и<sp/>меньше<sp/>или<sp/>равен<sp/>1&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="291"><highlight class="normal"></highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/>time_point_sec<sp/>now<sp/>=<sp/><sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="293"><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>state<sp/>=<sp/>emission_state_sing.get_or_default();</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/>state.tact_number<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/>state.tact_duration<sp/>=<sp/>tact_duration;</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/>state.emission_factor<sp/>=<sp/>emission_factor;</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/>state.current_supply<sp/>=<sp/>init_supply;</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/>state.tact_open_at<sp/>=<sp/>now;</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/>state.tact_close_at<sp/>=<sp/>eosio::time_point_sec(now.sec_since_epoch()<sp/>+<sp/>tact_duration);</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/>state.tact_fees<sp/>=<sp/>asset(0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>());</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/>state.back_from_producers<sp/>=<sp/>asset(0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>());</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/>state.tact_emission<sp/>=<sp/>asset(0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>());</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/>state.emission_start<sp/>=<sp/>asset(uint64_t(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">(init_supply.amount)<sp/>/<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal">(1<sp/>+<sp/>emission_factor)),<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>());</highlight></codeline>
<codeline lineno="307"><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/>emission_state_sing.set(state,<sp/>get_self());</highlight></codeline>
<codeline lineno="309"><highlight class="normal">}</highlight></codeline>
<codeline lineno="310"><highlight class="normal"></highlight></codeline>
<codeline lineno="311"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a426f4cdbba6766820a8625a6dcb6ee04" kindref="member">system_contract::update_tact</ref>()<sp/>{</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><ref refid="namespaceeosiosystem_1acc6ad551520c18fdac72d2ef9bfb26a9" kindref="member">emission_state_singleton</ref><sp/>emission_state_sing{<sp/>get_self(),<sp/>get_self().value};</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(emission_state_sing.exists())<sp/>{</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>state<sp/>=<sp/>emission_state_sing.get();</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/>time_point_sec<sp/>now<sp/>=<sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.tact_close_at<sp/>&lt;=<sp/>now)<sp/>{</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_number<sp/>+=<sp/>1;</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_open_at<sp/>=<sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_close_at<sp/>=<sp/>eosio::time_point_sec(now.sec_since_epoch()<sp/>+<sp/>state.tact_duration);</highlight></codeline>
<codeline lineno="324"><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Сдвигаем<sp/>границу<sp/>начала<sp/>эмиссии</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.emission_start<sp/>=<sp/>asset(uint64_t(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">(state.current_supply.amount)<sp/>/<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal">(1<sp/>+<sp/>state.emission_factor)),<sp/>state.current_supply.symbol);</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_fees.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_emission.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>emission_state_sing.set(state,<sp/>get_self());</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="333"><highlight class="normal">}</highlight></codeline>
<codeline lineno="334"><highlight class="normal"></highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a682be09e4bcb430df8e2ce98f1912563" kindref="member">system_contract::fill_tact</ref>(eosio::name<sp/>payer,<sp/>eosio::asset<sp/>payment)<sp/>{</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(payment.amount<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/>eosio::check(<ref refid="group__public__consts_1ga37aa40ea0f7329fa18e7e9be9d1d52ba" kindref="member">_producers_percent</ref><sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Процент<sp/>производителей<sp/>должен<sp/>быть<sp/>положителен&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/>eosio::check(<ref refid="group__public__consts_1ga6d8fd359800ecc9d5a1e2adff5e55b29" kindref="member">_fund_percent</ref><sp/>&gt;=<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Процент<sp/>фонд<sp/>должен<sp/>быть<sp/>больше<sp/>или<sp/>равен<sp/>нулю&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/>eosio::check(<ref refid="group__public__consts_1ga37aa40ea0f7329fa18e7e9be9d1d52ba" kindref="member">_producers_percent</ref><sp/>+<sp/><ref refid="group__public__consts_1ga6d8fd359800ecc9d5a1e2adff5e55b29" kindref="member">_fund_percent</ref><sp/>==<sp/><ref refid="consts_8hpp_1a8dca202ba0e066e3375d5314f0191389" kindref="member">HUNDR_PERCENTS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Сумма<sp/>вознаграждений<sp/>производителей<sp/>и<sp/>фонда<sp/>должны<sp/>в<sp/>сумме<sp/>равняться<sp/>100%<sp/>(1000000)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="340"><highlight class="normal"></highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Распределяем<sp/>поступления</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/>eosio::asset<sp/>producers_amount<sp/>=<sp/>payment<sp/>*<sp/><ref refid="group__public__consts_1ga37aa40ea0f7329fa18e7e9be9d1d52ba" kindref="member">_producers_percent</ref><sp/>/<sp/><ref refid="consts_8hpp_1a8dca202ba0e066e3375d5314f0191389" kindref="member">HUNDR_PERCENTS</ref>;</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/>eosio::asset<sp/>fund_amount<sp/>=<sp/>payment<sp/>*<sp/><ref refid="group__public__consts_1ga6d8fd359800ecc9d5a1e2adff5e55b29" kindref="member">_fund_percent</ref><sp/>/<sp/><ref refid="consts_8hpp_1a8dca202ba0e066e3375d5314f0191389" kindref="member">HUNDR_PERCENTS</ref>;<sp/></highlight></codeline>
<codeline lineno="344"><highlight class="normal"></highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Передаем<sp/>в<sp/>фонд</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classeosio_1_1token_1a48e0c826f1e416bf99439b0b7e637a29" kindref="member">eosio::token::transfer_action</ref><sp/>transfer_act1{<sp/><ref refid="classeosiosystem_1_1system__contract_1a21c029a978b1648e8cea9d7c60a5faf3" kindref="member">token_account</ref>,<sp/>{<sp/>{payer,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>}<sp/>}<sp/>};</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/>transfer_act1.send(<sp/>payer,<sp/><ref refid="group__public__consts_1gad32963d71641affbcefb02212f3166f3" kindref="member">_saving_account</ref>,<sp/>fund_amount,<sp/></highlight><highlight class="stringliteral">&quot;Передача<sp/>токенов<sp/>в<sp/>фонд&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Передаём<sp/>комиссии<sp/>делегатам<sp/>за<sp/>подписанные<sp/>блоки</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classeosio_1_1token_1a48e0c826f1e416bf99439b0b7e637a29" kindref="member">eosio::token::transfer_action</ref><sp/>transfer_act2{<sp/><ref refid="classeosiosystem_1_1system__contract_1a21c029a978b1648e8cea9d7c60a5faf3" kindref="member">token_account</ref>,<sp/>{<sp/>payer,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref><sp/>}<sp/>};</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/>transfer_act2.send(payer,<sp/><ref refid="classeosiosystem_1_1system__contract_1aeec189aa121eaf90aee0c180cd59cc26" kindref="member">bpay_account</ref>,<sp/>producers_amount,<sp/></highlight><highlight class="stringliteral">&quot;Передача<sp/>токенов<sp/>делегатам&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1acc6ad551520c18fdac72d2ef9bfb26a9" kindref="member">emission_state_singleton</ref><sp/>emission_state_sing{<sp/>get_self(),<sp/>get_self().value};</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(emission_state_sing.exists())<sp/>{</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a426f4cdbba6766820a8625a6dcb6ee04" kindref="member">update_tact</ref>();</highlight></codeline>
<codeline lineno="357"><highlight class="normal"></highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>state<sp/>=<sp/>emission_state_sing.get();</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Добавляем<sp/>собранные<sp/>комиссии<sp/>к<sp/>числу<sp/>комиссий<sp/>такта</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_fees<sp/>+=<sp/>payment;</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>state.back_from_producers<sp/>+=<sp/>producers_amount;</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab7c0fbe51aa0335e5048be97bf453db7" kindref="member">perblock_bucket</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+=<sp/>producers_amount.amount;</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1afabbd0323315bef9ad7b5d2f953a0340" kindref="member">last_pervote_bucket_fill</ref><sp/>=<sp/>eosio::current_time_point();</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>print(</highlight><highlight class="stringliteral">&quot;<sp/>Супплай:<sp/>&quot;</highlight><highlight class="normal">,<sp/>state.current_supply);</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>print(</highlight><highlight class="stringliteral">&quot;<sp/>Платеж:<sp/>&quot;</highlight><highlight class="normal">,<sp/>payment);</highlight></codeline>
<codeline lineno="369"><highlight class="normal"></highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//Производим<sp/>эмиссию<sp/>в<sp/>фонд<sp/>при<sp/>условии:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.tact_fees<sp/>&gt;<sp/>state.emission_start)<sp/>{</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::asset<sp/>new_emission<sp/>=<sp/>asset(uint64_t((1<sp/>+<sp/>state.emission_factor)<sp/>*<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">(state.tact_fees.amount))<sp/>-<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal">(state.current_supply.amount)),<sp/><ref refid="classeosiosystem_1_1system__contract_1a50976d2a74593cdd840662159dc21ab1" kindref="member">get_core_symbol</ref>());</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print(</highlight><highlight class="stringliteral">&quot;<sp/>Эмиссия<sp/>в<sp/>фонд<sp/>&quot;</highlight><highlight class="normal">,<sp/>new_emission);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"></highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_emission.amount<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Увеличиваем<sp/>объем<sp/>эмиссии<sp/>такта</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.tact_emission<sp/>+=<sp/>new_emission;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Увеличиваем<sp/>текущий<sp/>объем<sp/>в<sp/>обороте<sp/>на<sp/>сумму<sp/>эмиссии</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.current_supply<sp/>+=<sp/>new_emission;</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Эмимитируем<sp/>токены<sp/>в<sp/>фонд</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a7e80c965d15f6613db3ee04188d68af5" kindref="member">system_contract::emit</ref>(new_emission);</highlight></codeline>
<codeline lineno="385"><highlight class="normal"></highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Изменяем<sp/>веса<sp/>CPU<sp/>&amp;<sp/>NET<sp/>в<sp/>соответствии<sp/>с<sp/>новой<sp/>эмиссией</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a7180a3661c6dcf143333569d64dc9a27" kindref="member">system_contract::change_weights</ref>(payer,<sp/>new_emission);</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="391"><highlight class="normal"></highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>emission_state_sing.set(state,<sp/>get_self());</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="395"><highlight class="normal">}</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a7180a3661c6dcf143333569d64dc9a27" kindref="member">system_contract::change_weights</ref>(eosio::name<sp/>payer,<sp/>eosio::asset<sp/>new_emission)<sp/>{</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>power_state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/>eosio::check(power_state_sing.exists(),<sp/></highlight><highlight class="stringliteral">&quot;powerup<sp/>hasn&apos;t<sp/>been<sp/>initialized&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>power_state<sp/>=<sp/>power_state_sing.get();</highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/>power_state.cpu.weight<sp/>+=<sp/>new_emission.amount;</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/>power_state.net.weight<sp/>+=<sp/>new_emission.amount;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/>power_state.ram.weight<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a2a2f2607dd31f0623a7d5185bf967c4d" kindref="member">max_ram_size</ref>;</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/>power_state_sing.set(power_state,<sp/>get_self());</highlight></codeline>
<codeline lineno="407"><highlight class="normal">}</highlight></codeline>
<codeline lineno="408"><highlight class="normal"></highlight></codeline>
<codeline lineno="409"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace<sp/>eosiosystem</highlight><highlight class="normal"></highlight></codeline>
    </programlisting>
    <location file="system/contracts/eosio.system/src/powerup.cpp"/>
  </compounddef>
</doxygen>
