<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.3" xml:lang="ru">
  <compounddef id="delegate__bandwidth_8cpp" kind="file" language="C++">
    <compoundname>delegate_bandwidth.cpp</compoundname>
    <includes local="no">eosio/datastream.hpp</includes>
    <includes local="no">eosio/eosio.hpp</includes>
    <includes local="no">eosio/multi_index.hpp</includes>
    <includes local="no">eosio/privileged.hpp</includes>
    <includes local="no">eosio/serialize.hpp</includes>
    <includes local="no">eosio/transaction.hpp</includes>
    <includes refid="eosio_8system_8hpp" local="no">eosio.system/eosio.system.hpp</includes>
    <includes refid="eosio_8token_8hpp" local="no">eosio.token/eosio.token.hpp</includes>
    <incdepgraph>
      <node id="27">
        <label>../../../../../common/consts.hpp</label>
        <link refid="consts_8hpp"/>
      </node>
      <node id="8">
        <label>eosio.system/eosio.system.hpp</label>
        <link refid="eosio_8system_8hpp"/>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
      </node>
      <node id="15">
        <label>eosio.system/exchange_state.hpp</label>
        <link refid="exchange__state_8hpp"/>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="16">
        <label>eosio.system/native.hpp</label>
        <link refid="native_8hpp"/>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>system/contracts/eosio.system/src/delegate_bandwidth.cpp</label>
        <link refid="delegate__bandwidth_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
      </node>
      <node id="28">
        <label>eosio.token/eosio.token.hpp</label>
        <link refid="eosio_8token_8hpp"/>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
      </node>
      <node id="23">
        <label>deque</label>
      </node>
      <node id="17">
        <label>eosio/action.hpp</label>
      </node>
      <node id="9">
        <label>eosio/asset.hpp</label>
      </node>
      <node id="10">
        <label>eosio/binary_extension.hpp</label>
      </node>
      <node id="18">
        <label>eosio/contract.hpp</label>
      </node>
      <node id="19">
        <label>eosio/crypto.hpp</label>
      </node>
      <node id="2">
        <label>eosio/datastream.hpp</label>
      </node>
      <node id="3">
        <label>eosio/eosio.hpp</label>
      </node>
      <node id="20">
        <label>eosio/fixed_bytes.hpp</label>
      </node>
      <node id="21">
        <label>eosio/ignore.hpp</label>
      </node>
      <node id="4">
        <label>eosio/multi_index.hpp</label>
      </node>
      <node id="22">
        <label>eosio/print.hpp</label>
      </node>
      <node id="5">
        <label>eosio/privileged.hpp</label>
      </node>
      <node id="11">
        <label>eosio/producer_schedule.hpp</label>
      </node>
      <node id="6">
        <label>eosio/serialize.hpp</label>
      </node>
      <node id="12">
        <label>eosio/singleton.hpp</label>
      </node>
      <node id="13">
        <label>eosio/system.hpp</label>
      </node>
      <node id="14">
        <label>eosio/time.hpp</label>
      </node>
      <node id="7">
        <label>eosio/transaction.hpp</label>
      </node>
      <node id="24">
        <label>optional</label>
      </node>
      <node id="25">
        <label>string</label>
      </node>
      <node id="26">
        <label>type_traits</label>
      </node>
    </incdepgraph>
    <innernamespace refid="namespaceeosiosystem">eosiosystem</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="preprocessor">#include<sp/>&lt;eosio/datastream.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;eosio/eosio.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;eosio/multi_index.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;eosio/privileged.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;eosio/serialize.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;eosio/transaction.hpp&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="eosio_8system_8hpp" kindref="compound">eosio.system/eosio.system.hpp</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="eosio_8token_8hpp" kindref="compound">eosio.token/eosio.token.hpp</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespaceeosiosystem" kindref="compound">eosiosystem</ref><sp/>{</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::asset;</highlight></codeline>
<codeline lineno="14"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::const_mem_fun;</highlight></codeline>
<codeline lineno="15"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::current_time_point;</highlight></codeline>
<codeline lineno="16"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::indexed_by;</highlight></codeline>
<codeline lineno="17"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::permission_level;</highlight></codeline>
<codeline lineno="18"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::seconds;</highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/>eosio::time_point_sec;</highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keyword">using</highlight><highlight class="normal"><sp/><ref refid="classeosio_1_1token" kindref="compound">eosio::token</ref>;</highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a93950629ac6f931b47542727a5411097" kindref="member">system_contract::buyrambytes</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>payer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>receiver,<sp/>uint32_t<sp/>bytes<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a2b149f7463767158fac80045940da7d5" kindref="member">_rammarket</ref>.find(<ref refid="classeosiosystem_1_1system__contract_1ac0eb9382f47fc00bcf66b81a26805e73" kindref="member">ramcore_symbol</ref>.raw());</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>ram_reserve<sp/><sp/><sp/>=<sp/>itr-&gt;base.balance.amount;</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>eos_reserve<sp/><sp/><sp/>=<sp/>itr-&gt;quote.balance.amount;</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>cost<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/><ref refid="structeosiosystem_1_1exchange__state_1aab488cbf49b061bbb660f1bf5add2cf6" kindref="member">exchange_state::get_bancor_input</ref>(<sp/>ram_reserve,<sp/>eos_reserve,<sp/>bytes<sp/>);</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a04be77ea83f87d1533606390c37cf5d1" kindref="member">buyram</ref>(<sp/>payer,<sp/>receiver,<sp/>asset{<sp/>cost,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>()<sp/>}<sp/>);</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a04be77ea83f87d1533606390c37cf5d1" kindref="member">system_contract::buyram</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>payer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>receiver,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>quant<sp/>)</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>require_auth(<sp/>payer<sp/>);</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1ae248c8483e7ff56c697793c49bd58700" kindref="member">update_ram_supply</ref>();</highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state_sing.exists())<sp/>{</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>quant.symbol<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>(),<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>buy<sp/>ram<sp/>with<sp/>core<sp/>token&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>quant.amount<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>purchase<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>quant_after_fee<sp/>=<sp/>quant;<sp/></highlight><highlight class="comment">//<sp/>Полная<sp/>сумма<sp/>идет<sp/>на<sp/>покупку<sp/>RAM,<sp/>без<sp/>вычета<sp/>комиссии</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosio_1_1token_1a48e0c826f1e416bf99439b0b7e637a29" kindref="member">token::transfer_action</ref><sp/>transfer_act{<sp/><ref refid="classeosiosystem_1_1system__contract_1a21c029a978b1648e8cea9d7c60a5faf3" kindref="member">token_account</ref>,<sp/>{<sp/>{payer,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>},<sp/>{<ref refid="classeosiosystem_1_1system__contract_1a5b9e69a4f134680f236b696f7ec2ca0f" kindref="member">ram_account</ref>,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>}<sp/>}<sp/>};</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transfer_act.send(<sp/>payer,<sp/><ref refid="classeosiosystem_1_1system__contract_1a5b9e69a4f134680f236b696f7ec2ca0f" kindref="member">ram_account</ref>,<sp/>quant_after_fee,<sp/></highlight><highlight class="stringliteral">&quot;buy<sp/>ram&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>bytes_out;</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>market<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a2b149f7463767158fac80045940da7d5" kindref="member">_rammarket</ref>.get(<ref refid="classeosiosystem_1_1system__contract_1ac0eb9382f47fc00bcf66b81a26805e73" kindref="member">ramcore_symbol</ref>.raw(),<sp/></highlight><highlight class="stringliteral">&quot;ram<sp/>market<sp/>does<sp/>not<sp/>exist&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a2b149f7463767158fac80045940da7d5" kindref="member">_rammarket</ref>.modify(<sp/>market,<sp/>same_payer,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>es<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bytes_out<sp/>=<sp/>es.direct_convert(<sp/>quant,<sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a6317a93cd512ff0fc3b6a802bd5aa229" kindref="member">ram_symbol</ref><sp/>).amount;</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="65"><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab11f6efb709f15f9d31c3e8a20897149" kindref="member">total_ram_bytes_reserved</ref><sp/>+<sp/>uint64_t(bytes_out)<sp/>&lt;=<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a2a2f2607dd31f0623a7d5185bf967c4d" kindref="member">max_ram_size</ref>,<sp/></highlight><highlight class="stringliteral">&quot;покупка<sp/>RAM<sp/>сейчас<sp/>невозможна.&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>bytes_out<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>reserve<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a491a74bf4176ddd4485941a841fff13a" kindref="member">total_ram_stake</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+=<sp/>quant.amount;</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab11f6efb709f15f9d31c3e8a20897149" kindref="member">total_ram_bytes_reserved</ref><sp/>+=<sp/>uint64_t(bytes_out);</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a392bb6f33cd89eca7b90ee378a7ac8e3" kindref="member">user_resources_table</ref><sp/><sp/>userres(<sp/>get_self(),<sp/>receiver.value<sp/>);</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>res_itr<sp/>=<sp/>userres.find(<sp/>receiver.value<sp/>);</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>res_itr<sp/>==<sp/><sp/>userres.end()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res_itr<sp/>=<sp/>userres.emplace(<sp/>receiver,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>res<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res.owner<sp/>=<sp/>receiver;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res.net_weight<sp/>=<sp/>asset(<sp/>0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>()<sp/>);</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res.cpu_weight<sp/>=<sp/>asset(<sp/>0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>()<sp/>);</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res.ram_bytes<sp/>=<sp/>bytes_out;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>userres.modify(<sp/>res_itr,<sp/>receiver,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>res<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res.ram_bytes<sp/>+=<sp/>bytes_out;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>voter_itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.find(<sp/>res_itr-&gt;owner.value<sp/>);</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>voter_itr<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.end()<sp/>||<sp/>!<ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(<sp/>voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5ae149b497807ee78e9e5180d213e5a402" kindref="member">voter_info::flags1_fields::ram_managed</ref><sp/>)<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>ram_bytes,<sp/>net,<sp/>cpu;</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_resource_limits(<sp/>res_itr-&gt;owner,<sp/>ram_bytes,<sp/>net,<sp/>cpu<sp/>);</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_resource_limits(<sp/>res_itr-&gt;owner,<sp/>res_itr-&gt;ram_bytes<sp/>+<sp/><ref refid="namespaceeosiosystem_1a0843661bca3ab2494b8a85111041f078" kindref="member">ram_gift_bytes</ref>,<sp/>net,<sp/>cpu<sp/>);</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::print(</highlight><highlight class="stringliteral">&quot;Метод<sp/>безопасно<sp/>закрыт<sp/>для<sp/>вызова&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight></codeline>
<codeline lineno="100"><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a6b00b900a128d2718244ac8a408f65d3" kindref="member">system_contract::sellram</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/><ref refid="structaccount" kindref="compound">account</ref>,<sp/>int64_t<sp/>bytes<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>require_auth(get_self());</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1ae248c8483e7ff56c697793c49bd58700" kindref="member">update_ram_supply</ref>();</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state_sing.exists())<sp/>{</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>bytes<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;cannot<sp/>sell<sp/>negative<sp/>byte&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="109"><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a392bb6f33cd89eca7b90ee378a7ac8e3" kindref="member">user_resources_table</ref><sp/><sp/>userres(<sp/>get_self(),<sp/><ref refid="structaccount" kindref="compound">account</ref>.value<sp/>);</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>res_itr<sp/>=<sp/>userres.find(<sp/><ref refid="structaccount" kindref="compound">account</ref>.value<sp/>);</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>res_itr<sp/>!=<sp/>userres.end(),<sp/></highlight><highlight class="stringliteral">&quot;no<sp/>resource<sp/>row&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>res_itr-&gt;ram_bytes<sp/>&gt;=<sp/>bytes,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>quota&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>bytes<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;cannot<sp/>back<sp/>negative<sp/>byte&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>asset<sp/>tokens_out;</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a2b149f7463767158fac80045940da7d5" kindref="member">_rammarket</ref>.find(<ref refid="classeosiosystem_1_1system__contract_1ac0eb9382f47fc00bcf66b81a26805e73" kindref="member">ramcore_symbol</ref>.raw());</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a2b149f7463767158fac80045940da7d5" kindref="member">_rammarket</ref>.modify(<sp/>itr,<sp/>same_payer,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>es<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_out<sp/>=<sp/>es.direct_convert(<sp/>asset(bytes,<sp/><ref refid="classeosiosystem_1_1system__contract_1a6317a93cd512ff0fc3b6a802bd5aa229" kindref="member">ram_symbol</ref>),<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>());</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="123"><highlight class="normal"></highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>tokens_out.amount<sp/>&gt;<sp/>1,<sp/></highlight><highlight class="stringliteral">&quot;token<sp/>amount<sp/>received<sp/>from<sp/>selling<sp/>ram<sp/>is<sp/>too<sp/>low&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1ab11f6efb709f15f9d31c3e8a20897149" kindref="member">total_ram_bytes_reserved</ref><sp/>-=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">decltype(<ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.total_ram_bytes_reserved)</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(bytes);</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a491a74bf4176ddd4485941a841fff13a" kindref="member">total_ram_stake</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-=<sp/>tokens_out.amount;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a491a74bf4176ddd4485941a841fff13a" kindref="member">total_ram_stake</ref><sp/>&gt;=<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;error,<sp/>attempt<sp/>to<sp/>unstake<sp/>more<sp/>tokens<sp/>than<sp/>previously<sp/>staked&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>voter_itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.find(<sp/>res_itr-&gt;owner.value<sp/>);</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>voter_itr<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.end()<sp/>||<sp/>!<ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(<sp/>voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5ae149b497807ee78e9e5180d213e5a402" kindref="member">voter_info::flags1_fields::ram_managed</ref><sp/>)<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>ram_usage,<sp/>net,<sp/>cpu;</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_resource_limits(<sp/>res_itr-&gt;owner,<sp/>ram_usage,<sp/>net,<sp/>cpu<sp/>);</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_resource_limits(<sp/>res_itr-&gt;owner,<sp/>res_itr-&gt;ram_bytes<sp/>+<sp/><ref refid="namespaceeosiosystem_1a0843661bca3ab2494b8a85111041f078" kindref="member">ram_gift_bytes</ref>,<sp/>net,<sp/>cpu<sp/>);</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>userres.modify(<sp/>res_itr,<sp/>same_payer,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>res<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res.ram_bytes<sp/>-=<sp/>bytes;</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::print(</highlight><highlight class="stringliteral">&quot;Метод<sp/>безопасно<sp/>закрыт<sp/>для<sp/>вызова&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1aa4121046f43083640f3276a4e7974572" kindref="member">system_contract::changebw</ref>(<sp/>name<sp/>from,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>receiver,</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>stake_net_delta,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>stake_cpu_delta,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>transfer<sp/>)</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>require_auth(<sp/>from<sp/>);</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>stake_net_delta.amount<sp/>!=<sp/>0<sp/>||<sp/>stake_cpu_delta.amount<sp/>!=<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;should<sp/>stake<sp/>non-zero<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>std::abs(<sp/>(stake_net_delta<sp/>+<sp/>stake_cpu_delta).amount<sp/>)</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;=<sp/>std::max(<sp/>std::abs(<sp/>stake_net_delta.amount<sp/>),<sp/>std::abs(<sp/>stake_cpu_delta.amount<sp/>)<sp/>),</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;net<sp/>and<sp/>cpu<sp/>deltas<sp/>cannot<sp/>be<sp/>opposite<sp/>signs&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>name<sp/>source_stake_from<sp/>=<sp/>from;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>transfer<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>from<sp/>=<sp/>receiver;</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>update<sp/>stake<sp/>delegated<sp/>from<sp/>&quot;from&quot;<sp/>to<sp/>&quot;receiver&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a4e16d907ef29397151873e2b4af00694" kindref="member">del_bandwidth_table</ref><sp/><sp/><sp/><sp/><sp/>del_tbl(<sp/>get_self(),<sp/>from.value<sp/>);</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>itr<sp/>=<sp/>del_tbl.find(<sp/>receiver.value<sp/>);</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>itr<sp/>==<sp/>del_tbl.end()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>itr<sp/>=<sp/>del_tbl.emplace(<sp/>from,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>dbo<sp/>){</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbo.from<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>from;</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbo.to<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>receiver;</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbo.net_weight<sp/><sp/><sp/><sp/>=<sp/>stake_net_delta;</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbo.cpu_weight<sp/><sp/><sp/><sp/>=<sp/>stake_cpu_delta;</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>del_tbl.modify(<sp/>itr,<sp/>same_payer,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>dbo<sp/>){</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbo.net_weight<sp/><sp/><sp/><sp/>+=<sp/>stake_net_delta;</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbo.cpu_weight<sp/><sp/><sp/><sp/>+=<sp/>stake_cpu_delta;</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>itr-&gt;net_weight.amount,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>net<sp/>bandwidth&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>itr-&gt;cpu_weight.amount,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>cpu<sp/>bandwidth&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>itr-&gt;is_empty()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>del_tbl.erase(<sp/>itr<sp/>);</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>itr<sp/>can<sp/>be<sp/>invalid,<sp/>should<sp/>go<sp/>out<sp/>of<sp/>scope</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"></highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>update<sp/>totals<sp/>of<sp/>&quot;receiver&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a392bb6f33cd89eca7b90ee378a7ac8e3" kindref="member">user_resources_table</ref><sp/><sp/><sp/>totals_tbl(<sp/>get_self(),<sp/>receiver.value<sp/>);</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tot_itr<sp/>=<sp/>totals_tbl.find(<sp/>receiver.value<sp/>);</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>tot_itr<sp/>==<sp/><sp/>totals_tbl.end()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot_itr<sp/>=<sp/>totals_tbl.emplace(<sp/>from,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tot<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.owner<sp/>=<sp/>receiver;</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.net_weight<sp/><sp/><sp/><sp/>=<sp/>stake_net_delta;</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.cpu_weight<sp/><sp/><sp/><sp/>=<sp/>stake_cpu_delta;</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>totals_tbl.modify(<sp/>tot_itr,<sp/>from<sp/>==<sp/>receiver<sp/>?<sp/>from<sp/>:<sp/>same_payer,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tot<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.net_weight<sp/><sp/><sp/><sp/>+=<sp/>stake_net_delta;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tot.cpu_weight<sp/><sp/><sp/><sp/>+=<sp/>stake_cpu_delta;</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>tot_itr-&gt;net_weight.amount,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>total<sp/>net<sp/>bandwidth&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>tot_itr-&gt;cpu_weight.amount,<sp/></highlight><highlight class="stringliteral">&quot;insufficient<sp/>staked<sp/>total<sp/>cpu<sp/>bandwidth&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="204"><highlight class="normal"></highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ram_managed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>net_managed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>cpu_managed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="209"><highlight class="normal"></highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>voter_itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.find(<sp/>receiver.value<sp/>);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>voter_itr<sp/>!=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.end()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ram_managed<sp/>=<sp/><ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(<sp/>voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5ae149b497807ee78e9e5180d213e5a402" kindref="member">voter_info::flags1_fields::ram_managed</ref><sp/>);</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>net_managed<sp/>=<sp/><ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(<sp/>voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5a944559ad694d4c0fc4bf286864caf2a2" kindref="member">voter_info::flags1_fields::net_managed</ref><sp/>);</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cpu_managed<sp/>=<sp/><ref refid="namespaceeosiosystem_1a6c407cd2889dff2a2fd87aa6ff808b0e" kindref="member">has_field</ref>(<sp/>voter_itr-&gt;flags1,<sp/><ref refid="structeosiosystem_1_1voter__info_1a6bb7318b053ad6dbbde3a0f4415d2cf5ace319c6a1aa0ced6ea5a02270d863f4c" kindref="member">voter_info::flags1_fields::cpu_managed</ref><sp/>);</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="216"><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>!(net_managed<sp/>&amp;&amp;<sp/>cpu_managed)<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>ram_bytes,<sp/>net,<sp/>cpu;</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_resource_limits(<sp/>receiver,<sp/>ram_bytes,<sp/>net,<sp/>cpu<sp/>);</highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_resource_limits(<sp/>receiver,</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ram_managed<sp/>?<sp/>ram_bytes<sp/>:<sp/>std::max(<sp/>tot_itr-&gt;ram_bytes<sp/>+<sp/><ref refid="namespaceeosiosystem_1a0843661bca3ab2494b8a85111041f078" kindref="member">ram_gift_bytes</ref>,<sp/>ram_bytes<sp/>),</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>net_managed<sp/>?<sp/>net<sp/>:<sp/>tot_itr-&gt;net_weight.amount,</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cpu_managed<sp/>?<sp/>cpu<sp/>:<sp/>tot_itr-&gt;cpu_weight.amount<sp/>);</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="227"><highlight class="normal"></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>tot_itr-&gt;is_empty()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>totals_tbl.erase(<sp/>tot_itr<sp/>);</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>tot_itr<sp/>can<sp/>be<sp/>invalid,<sp/>should<sp/>go<sp/>out<sp/>of<sp/>scope</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>create<sp/>refund<sp/>or<sp/>update<sp/>from<sp/>existing<sp/>refund<sp/>only<sp/>if<sp/>powerup<sp/>is<sp/>not<sp/>enabled</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/><ref refid="classeosiosystem_1_1system__contract_1a5cde7e6a57d453cc63d509c6657355e2" kindref="member">stake_account</ref><sp/>!=<sp/>source_stake_from<sp/>&amp;&amp;<sp/>!state_sing.exists()<sp/>)<sp/>{<sp/></highlight><highlight class="comment">//for<sp/>eosio<sp/>both<sp/>transfer<sp/>and<sp/>refund<sp/>make<sp/>no<sp/>sense</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1aa3f5a7875c9a421bed214a88d78d7750" kindref="member">refunds_table</ref><sp/>refunds_tbl(<sp/>get_self(),<sp/>from.value<sp/>);</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>req<sp/>=<sp/>refunds_tbl.find(<sp/>from.value<sp/>);</highlight></codeline>
<codeline lineno="240"><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//create/update/delete<sp/>refund</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>net_balance<sp/>=<sp/>stake_net_delta;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cpu_balance<sp/>=<sp/>stake_cpu_delta;</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>need_deferred_trx<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>net<sp/>and<sp/>cpu<sp/>are<sp/>same<sp/>sign<sp/>by<sp/>assertions<sp/>in<sp/>delegatebw<sp/>and<sp/>undelegatebw</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>redundant<sp/>assertion<sp/>also<sp/>at<sp/>start<sp/>of<sp/>changebw<sp/>to<sp/>protect<sp/>against<sp/>misuse<sp/>of<sp/>changebw</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_undelegating<sp/>=<sp/>(net_balance.amount<sp/>+<sp/>cpu_balance.amount<sp/>)<sp/>&lt;<sp/>0;</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_delegating_to_self<sp/>=<sp/>(!transfer<sp/>&amp;&amp;<sp/>from<sp/>==<sp/>receiver);</highlight></codeline>
<codeline lineno="251"><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>is_delegating_to_self<sp/>||<sp/>is_undelegating<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>req<sp/>!=<sp/>refunds_tbl.end()<sp/>)<sp/>{<sp/></highlight><highlight class="comment">//need<sp/>to<sp/>update<sp/>refund</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>refunds_tbl.modify(<sp/>req,<sp/>same_payer,<sp/>[&amp;](<sp/>refund_request&amp;<sp/>r<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>net_balance.amount<sp/>&lt;<sp/>0<sp/>||<sp/>cpu_balance.amount<sp/>&lt;<sp/>0<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.request_time<sp/>=<sp/>current_time_point();</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.net_amount<sp/>-=<sp/>net_balance;</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>r.net_amount.amount<sp/>&lt;<sp/>0<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>net_balance<sp/>=<sp/>-r.net_amount;</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.net_amount.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>net_balance.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.cpu_amount<sp/>-=<sp/>cpu_balance;</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>r.cpu_amount.amount<sp/>&lt;<sp/>0<sp/>){</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cpu_balance<sp/>=<sp/>-r.cpu_amount;</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.cpu_amount.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cpu_balance.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>req-&gt;net_amount.amount,<sp/></highlight><highlight class="stringliteral">&quot;negative<sp/>net<sp/>refund<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);<sp/></highlight><highlight class="comment">//should<sp/>never<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>req-&gt;cpu_amount.amount,<sp/></highlight><highlight class="stringliteral">&quot;negative<sp/>cpu<sp/>refund<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);<sp/></highlight><highlight class="comment">//should<sp/>never<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>req-&gt;is_empty()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>refunds_tbl.erase(<sp/>req<sp/>);</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>need_deferred_trx<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>need_deferred_trx<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>net_balance.amount<sp/>&lt;<sp/>0<sp/>||<sp/>cpu_balance.amount<sp/>&lt;<sp/>0<sp/>)<sp/>{<sp/></highlight><highlight class="comment">//need<sp/>to<sp/>create<sp/>refund</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>refunds_tbl.emplace(<sp/>from,<sp/>[&amp;](<sp/>refund_request&amp;<sp/>r<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.owner<sp/>=<sp/>from;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>net_balance.amount<sp/>&lt;<sp/>0<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.net_amount<sp/>=<sp/>-net_balance;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>net_balance.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.net_amount<sp/>=<sp/>asset(<sp/>0,<sp/>core_symbol()<sp/>);</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(<sp/>cpu_balance.amount<sp/>&lt;<sp/>0<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.cpu_amount<sp/>=<sp/>-cpu_balance;</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cpu_balance.amount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.cpu_amount<sp/>=<sp/>asset(<sp/>0,<sp/>core_symbol()<sp/>);</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r.request_time<sp/>=<sp/>current_time_point();</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>need_deferred_trx<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>else<sp/>stake<sp/>increase<sp/>requested<sp/>with<sp/>no<sp/>existing<sp/>row<sp/>in<sp/>refunds_tbl<sp/>-&gt;<sp/>nothing<sp/>to<sp/>do<sp/>with<sp/>refunds_tbl</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight></codeline>
<codeline lineno="303"><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>need_deferred_trx<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::transaction<sp/>out;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out.actions.emplace_back(<sp/>permission_level{from,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>},</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_self(),<sp/></highlight><highlight class="stringliteral">&quot;refund&quot;</highlight><highlight class="normal">_n,</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>from</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out.delay_sec<sp/>=<sp/><ref refid="namespaceeosiosystem_1ac8dd7319fe241152601b25ac397495f9" kindref="member">refund_delay_sec</ref>;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::cancel_deferred(<sp/>from.value<sp/>);<sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>Remove<sp/>this<sp/>line<sp/>when<sp/>replacing<sp/>deferred<sp/>transactions<sp/>is<sp/>fixed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out.send(<sp/>from.value,<sp/>from,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::cancel_deferred(<sp/>from.value<sp/>);</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="316"><highlight class="normal"></highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>transfer_amount<sp/>=<sp/>net_balance<sp/>+<sp/>cpu_balance;</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>0<sp/>&lt;<sp/>transfer_amount.amount<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosio_1_1token_1a48e0c826f1e416bf99439b0b7e637a29" kindref="member">token::transfer_action</ref><sp/>transfer_act{<sp/><ref refid="classeosiosystem_1_1system__contract_1a21c029a978b1648e8cea9d7c60a5faf3" kindref="member">token_account</ref>,<sp/>{<sp/>{source_stake_from,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>}<sp/>}<sp/>};</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transfer_act.send(<sp/>source_stake_from,<sp/><ref refid="classeosiosystem_1_1system__contract_1a5cde7e6a57d453cc63d509c6657355e2" kindref="member">stake_account</ref>,<sp/>asset(transfer_amount),<sp/></highlight><highlight class="stringliteral">&quot;stake<sp/>bandwidth&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="323"><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1aa192ed8af461c5162749a1a7f3886f06" kindref="member">update_voting_power</ref>(<sp/>from,<sp/>stake_net_delta<sp/>+<sp/>stake_cpu_delta<sp/>);</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="326"><highlight class="normal"></highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1aa192ed8af461c5162749a1a7f3886f06" kindref="member">system_contract::update_voting_power</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>voter,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>total_update<sp/>)</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>voter_itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.find(<sp/>voter.value<sp/>);</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>voter_itr<sp/>==<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.end()<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>voter_itr<sp/>=<sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.emplace(<sp/>voter,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>v<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v.owner<sp/><sp/>=<sp/>voter;</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v.staked<sp/>=<sp/>total_update.amount;</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1a41105c20306ae2478d91e0fab56f2e58" kindref="member">_voters</ref>.modify(<sp/>voter_itr,<sp/>same_payer,<sp/>[&amp;](<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>v<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v.staked<sp/>+=<sp/>total_update.amount;</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="340"><highlight class="normal"></highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>0<sp/>&lt;=<sp/>voter_itr-&gt;staked,<sp/></highlight><highlight class="stringliteral">&quot;stake<sp/>for<sp/>voting<sp/>cannot<sp/>be<sp/>negative&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="342"><highlight class="normal"></highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>voter_itr-&gt;producers.size()<sp/>||<sp/>voter_itr-&gt;proxy<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1aac11a1b221a613107fb8ca99e080a616" kindref="member">update_votes</ref>(<sp/>voter,<sp/>voter_itr-&gt;proxy,<sp/>voter_itr-&gt;producers,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="347"><highlight class="normal"></highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1aa54b498595abb1a3ad9c62c597d4f7b5" kindref="member">system_contract::delegatebw</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>from,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>receiver,</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>stake_net_quantity,</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>stake_cpu_quantity,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>transfer<sp/>)</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>asset<sp/>zero_asset(<sp/>0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>()<sp/>);</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>stake_cpu_quantity<sp/>&gt;=<sp/>zero_asset,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>stake<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>stake_net_quantity<sp/>&gt;=<sp/>zero_asset,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>stake<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>stake_net_quantity.amount<sp/>+<sp/>stake_cpu_quantity.amount<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>stake<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>!transfer<sp/>||<sp/>from<sp/>!=<sp/>receiver,<sp/></highlight><highlight class="stringliteral">&quot;cannot<sp/>use<sp/>transfer<sp/>flag<sp/>if<sp/>delegating<sp/>to<sp/>self&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state_sing.exists())<sp/>{</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1aa4121046f43083640f3276a4e7974572" kindref="member">changebw</ref>(<sp/>from,<sp/>receiver,<sp/>stake_net_quantity,<sp/>stake_cpu_quantity,<sp/>transfer);</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::print(</highlight><highlight class="stringliteral">&quot;Метод<sp/>безопасно<sp/>закрыт<sp/>для<sp/>вызова&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>delegatebw</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a4db0be2c90d342ecd269fdbb57c51091" kindref="member">system_contract::undelegatebw</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>from,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>receiver,</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>unstake_net_quantity,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>asset&amp;<sp/>unstake_cpu_quantity<sp/>)</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>asset<sp/>zero_asset(<sp/>0,<sp/><ref refid="classeosiosystem_1_1system__contract_1a32504695292c0e9c2171987821bc3857" kindref="member">core_symbol</ref>()<sp/>);</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>unstake_cpu_quantity<sp/>&gt;=<sp/>zero_asset,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>unstake<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>unstake_net_quantity<sp/>&gt;=<sp/>zero_asset,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>unstake<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>unstake_cpu_quantity.amount<sp/>+<sp/>unstake_net_quantity.amount<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;must<sp/>unstake<sp/>a<sp/>positive<sp/>amount&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/><ref refid="classeosiosystem_1_1system__contract_1a40e74853eda24e1b15d8f5b6499c8820" kindref="member">_gstate</ref>.<ref refid="structeosiosystem_1_1eosio__global__state_1a67107f34cfdffa85a1195ed0e64612db" kindref="member">thresh_activated_stake_time</ref><sp/>!=<sp/><ref refid="namespacesystem__contracts_1_1testing_1_1test__contracts_1_1blockinfo__tester_1aada4f815458e881f7140c74078089f01" kindref="member">time_point</ref>(),</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;cannot<sp/>undelegate<sp/>bandwidth<sp/>until<sp/>the<sp/>chain<sp/>is<sp/>activated<sp/>(at<sp/>least<sp/>15%<sp/>of<sp/>all<sp/>tokens<sp/>participate<sp/>in<sp/>voting)&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1a3f7272bcaba5ffb74778b45ecd0fe547" kindref="member">powerup_state_singleton</ref><sp/>state_sing{<sp/>get_self(),<sp/>0<sp/>};</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state_sing.exists())<sp/>{</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosiosystem_1_1system__contract_1aa4121046f43083640f3276a4e7974572" kindref="member">changebw</ref>(<sp/>from,<sp/>receiver,<sp/>-unstake_net_quantity,<sp/>-unstake_cpu_quantity,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eosio::print(</highlight><highlight class="stringliteral">&quot;Метод<sp/>безопасно<sp/>закрыт<sp/>для<sp/>вызова&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>undelegatebw</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="385"><highlight class="normal"></highlight></codeline>
<codeline lineno="386"><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classeosiosystem_1_1system__contract_1a10a63e006f9869caeaf2592bdfbccc42" kindref="member">system_contract::refund</ref>(<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>name&amp;<sp/>owner<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>require_auth(<sp/>owner<sp/>);</highlight></codeline>
<codeline lineno="389"><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceeosiosystem_1aa3f5a7875c9a421bed214a88d78d7750" kindref="member">refunds_table</ref><sp/>refunds_tbl(<sp/>get_self(),<sp/>owner.value<sp/>);</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>req<sp/>=<sp/>refunds_tbl.find(<sp/>owner.value<sp/>);</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>req<sp/>!=<sp/>refunds_tbl.end(),<sp/></highlight><highlight class="stringliteral">&quot;refund<sp/>request<sp/>not<sp/>found&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>check(<sp/>req-&gt;request_time<sp/>+<sp/>seconds(<ref refid="namespaceeosiosystem_1ac8dd7319fe241152601b25ac397495f9" kindref="member">refund_delay_sec</ref>)<sp/>&lt;=<sp/>current_time_point(),</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;refund<sp/>is<sp/>not<sp/>available<sp/>yet&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classeosio_1_1token_1a48e0c826f1e416bf99439b0b7e637a29" kindref="member">token::transfer_action</ref><sp/>transfer_act{<sp/><ref refid="classeosiosystem_1_1system__contract_1a21c029a978b1648e8cea9d7c60a5faf3" kindref="member">token_account</ref>,<sp/>{<sp/>{<ref refid="classeosiosystem_1_1system__contract_1a5cde7e6a57d453cc63d509c6657355e2" kindref="member">stake_account</ref>,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>},<sp/>{req-&gt;owner,<sp/><ref refid="classeosiosystem_1_1system__contract_1adfc25b00a14e482c7fb1161dd38096bd" kindref="member">active_permission</ref>}<sp/>}<sp/>};</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>transfer_act.send(<sp/><ref refid="classeosiosystem_1_1system__contract_1a5cde7e6a57d453cc63d509c6657355e2" kindref="member">stake_account</ref>,<sp/>req-&gt;owner,<sp/>req-&gt;net_amount<sp/>+<sp/>req-&gt;cpu_amount,<sp/></highlight><highlight class="stringliteral">&quot;unstake&quot;</highlight><highlight class="normal"><sp/>);</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>refunds_tbl.erase(<sp/>req<sp/>);</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="399"><highlight class="normal"></highlight></codeline>
<codeline lineno="400"><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal">}<sp/></highlight><highlight class="comment">//namespace<sp/>eosiosystem</highlight><highlight class="normal"></highlight></codeline>
    </programlisting>
    <location file="system/contracts/eosio.system/src/delegate_bandwidth.cpp"/>
  </compounddef>
</doxygen>
